<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>晶圓路徑系統 (完整修正版)</title>
    <style>
        :root { --primary: #007ACC; --panel: #fff; --bg: #f4f7f6; }
        body { font-family: "Segoe UI", sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        
        h2 { margin-bottom: 20px; color: #333; }

        .container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 1400px; width: 100%; }

        /* 左側設定區 */
        .sidebar { 
            flex: 1; min-width: 420px; background: var(--panel); padding: 20px; 
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: fit-content;
        }

        .section-title { 
            font-size: 15px; font-weight: bold; color: #444; border-bottom: 2px solid #eee; 
            padding-bottom: 5px; margin-top: 20px; margin-bottom: 10px; 
        }
        .section-title:first-child { margin-top: 0; }

        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .input-row label { font-size: 14px; color: #555; font-weight: 500; }
        .input-row input[type="number"] { 
            width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; 
            text-align: right; font-family: monospace; 
        }
        
        /* 模式切換 */
        .mode-switch { display: flex; gap: 5px; margin-bottom: 15px; background: #eee; padding: 5px; border-radius: 6px; flex-wrap: wrap;}
        .mode-label { 
            flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 4px; font-weight: bold; font-size: 13px; color: #666;
            transition: 0.2s; min-width: 70px;
        }
        .mode-label:hover { background: #ddd; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .mode-label { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* 象限設定 */
        .quad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .quad-box { border: 1px solid #ccc; border-radius: 6px; padding: 8px; background: #fafafa; display: flex; flex-direction: column; gap: 5px; }
        .quad-title { font-weight: bold; font-size: 13px; color: #333; border-bottom: 1px dashed #ddd; padding-bottom: 3px; }
        .quad-select { width: 100%; padding: 4px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;}

        /* 起始點九宮格 */
        .corner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; width: 140px; margin-left: auto;}
        .corner-btn { padding: 5px; border: 1px solid #ccc; background: white; text-align: center; cursor: pointer; font-size: 12px; border-radius: 4px; }
        .corner-btn:hover { background: #f0f0f0; }
        .corner-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* === 選項按鈕樣式 (修復亮顯) === */
        .options-box { background: #e0f2f1; padding: 10px; border-radius: 4px; border: 1px solid #80cbc4; margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px;}
        .radio-group { display: flex; gap: 8px; font-size: 13px; font-weight: bold; color: #555; flex-wrap: wrap;}
        
        .radio-group label { 
            cursor: pointer; display: flex; align-items: center; gap: 5px; 
            padding: 5px 10px; background: white; border: 1px solid #ccc; border-radius: 4px; transition: 0.2s;
        }
        /* 選中時的樣式 */
        .radio-group label:has(input:checked) { 
            background-color: var(--primary); 
            color: white; 
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .radio-group input { margin: 0; accent-color: white;} 

        .start-flag-row { background: #ffebee; border-left: 3px solid #f44336; padding-left: 5px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-refresh { background: #333; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-dl-sub { background: #00897b; color: white; font-size: 12px; padding: 8px;}
        
        .canvas-container { flex: 2; min-width: 600px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; position: relative;}
        svg { border: 1px solid #ddd; background: #fff; max-width: 100%; height: auto; }
        .legend { display: flex; gap: 15px; margin-top: 10px; font-size: 12px; color: #666; flex-wrap: wrap; justify-content: center; }
        .leg-item { display: flex; align-items: center; gap: 5px; }
        .color-box { width: 15px; height: 15px; border-radius: 3px; }
        .line-demo { width: 25px; height: 3px; }
        .status-box { margin-top: 15px; padding: 10px; background: #eef7fe; color: #005fa3; border-left: 4px solid var(--primary); font-size: 13px; width: 90%; }
        
        /* 統計與時間 */
        .stats-panel { margin-top: 15px; padding: 10px; background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 6px; }
        
        /* 工時面板 (公用) */
        .time-panel { 
            margin-bottom: 15px; padding: 10px; background: #fff3e0; border: 1px solid #ffe0b2; border-radius: 6px; 
        }
        .panel-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px dashed #ccc; padding-bottom: 4px; color: #444; }
        .stat-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px; color: #333; }
        .stat-val { font-weight: bold; font-family: monospace; font-size: 15px;}

        .group-params { display: none; }
        .mode-wafer-active .group-wafer { display: block; }
        .mode-rect-active .group-rect { display: block; }
        .mode-zigzag-active .group-zigzag { display: block; }
        .mode-quadrant-active .group-quadrant { display: block; }
    </style>
</head>
<body class="mode-wafer-active">

    <h2>晶圓路徑系統 (完整修正版)</h2>

    <div class="container">
        <div class="sidebar">
            <div class="mode-switch">
                <input type="radio" name="mode" id="m_wafer" checked onchange="setMode('wafer')">
                <label for="m_wafer" class="mode-label">1. 晶圓</label>
                <input type="radio" name="mode" id="m_rect" onchange="setMode('rect')">
                <label for="m_rect" class="mode-label">2. 矩形</label>
                <input type="radio" name="mode" id="m_zigzag" onchange="setMode('zigzag')">
                <label for="m_zigzag" class="mode-label">3. Z字形</label>
                <input type="radio" name="mode" id="m_quadrant" onchange="setMode('quadrant')">
                <label for="m_quadrant" class="mode-label" style="color:#d84315;">4. 象限</label>
            </div>

            <div class="time-panel">
                <div class="panel-title" style="color:#ef6c00;">工時預估 (All Modes)</div>
                <div class="input-row"><label>作業速 (mm/s):</label><input type="number" id="speed_work" value="30" onchange="calculateTime()"></div>
                <div class="input-row"><label>快移速 (mm/s):</label><input type="number" id="speed_jump" value="200" onchange="calculateTime()"></div>
                
                <div class="input-row" style="background:#fff8e1; border-left:3px solid #ff9800; padding-left:5px;">
                    <label>加減速 (s):</label><input type="number" id="time_acc" value="0.02" step="0.01" onchange="calculateTime()">
                </div>
                
                <hr style="border:0; border-top:1px dashed #ccc; margin:5px 0;">
                <div class="stat-row"><span>總線段數:</span> <span class="stat-val" id="res_segs">0</span></div>
                <div class="stat-row"><span>總路徑長:</span> <span class="stat-val" id="res_dist">0 m</span></div>
                <div class="stat-row"><span>預估時間:</span> <span class="stat-val" id="res_time" style="color:#d84315; font-size:16px;">00:00</span></div>
            </div>

            <div class="section-title">全域顯示與參數</div>
            <div class="input-row"><label>SVG 線條粗細:</label><input type="number" id="v_stroke" value="0.05" step="0.01"></div>
            <div class="input-row" style="margin-top:5px;"><label><input type="checkbox" id="v_show_grid" checked> 顯示晶片網格</label></div>

            <div id="wafer-dims">
                <div class="section-title">晶圓與晶片尺寸</div>
                <div class="input-row"><label>直徑 (inch):</label><input type="number" id="w_dia" value="8.0"></div>
                <div class="input-row"><label>邊緣內縮 (mm):</label><input type="number" id="w_margin" value="5.0"></div>
                <div class="input-row"><label>晶片寬 X (mm):</label><input type="number" id="w_die_w" value="1.645"></div>
                <div class="input-row"><label>晶片高 Y (mm):</label><input type="number" id="w_die_h" value="0.945"></div>
                <div class="input-row"><label>切割道 Scribe:</label><input type="number" id="w_scribe" value="0.055"></div>
                <div class="input-row"><label>線段長度 Len:</label><input type="number" id="w_seg_len" value="0.4"></div>
            </div>

            <div class="group-params group-wafer">
                <div class="section-title">路徑策略</div>
                <div class="options-box">
                    <div style="font-size:12px; color:#666;">動作類型 (Pattern):</div>
                    <div class="radio-group">
                        <label><input type="radio" name="w_pattern" value="line" checked onchange="render()"> 橫向線段</label>
                        <label><input type="radio" name="w_pattern" value="zigzag" onchange="render()"> 垂直 Z字</label>
                    </div>
                    <hr style="width:100%; border:0; border-top:1px dashed #bbb; margin:5px 0;">
                    <div style="font-size:12px; color:#666;">掃描方式 (Travel):</div>
                    <div class="radio-group">
                        <label><input type="radio" name="w_travel" value="jump" onchange="render()"> 跳躍 (Jump)</label>
                        <label><input type="radio" name="w_travel" value="snake" checked onchange="render()"> 蛇行 (Snake)</label>
                        <label><input type="radio" name="w_travel" value="jumpsnake" onchange="render()"> 切割道 (J-Snake)</label>
                    </div>
                </div>
                <div class="input-row">
                    <label>起始角落:</label>
                    <div class="corner-grid">
                        <div class="corner-btn active" id="btn-w-tl" onclick="setCorner('w', 'tl')">左上</div>
                        <div class="corner-btn" id="btn-w-tr" onclick="setCorner('w', 'tr')">右上</div>
                        <div class="corner-btn" id="btn-w-bl" onclick="setCorner('w', 'bl')">左下</div>
                        <div class="corner-btn" id="btn-w-br" onclick="setCorner('w', 'br')">右下</div>
                    </div>
                    <input type="hidden" id="w_corner" value="tl">
                </div>
                <div class="input-row start-flag-row"><label>第一點 Flag:</label><input type="number" id="w_start_f" value="2"></div>
            </div>

            <div class="group-params group-quadrant">
                <div class="section-title">象限設定</div>
                <div class="quad-grid">
                    <div class="quad-box" style="border-color:#2196f3;">
                        <div class="quad-title" style="color:#1565c0;">Q2 (左上) X- Y-</div>
                        <select id="q2_pattern" class="quad-select" onchange="render()"><option value="none">None</option><option value="line" selected>Line</option><option value="zigzag">Zig</option></select>
                        <select id="q2_travel" class="quad-select" onchange="render()">
                            <option value="snake" selected>Snake</option><option value="jump">Jump</option><option value="jumpsnake">J-Snake</option>
                        </select>
                        <select id="q2_corner" class="quad-select" onchange="render()"><option value="tl" selected>起:左上</option><option value="tr">起:右上</option><option value="bl">起:左下</option><option value="br">起:右下</option></select>
                    </div>
                    <div class="quad-box" style="border-color:#4caf50;">
                        <div class="quad-title" style="color:#2e7d32;">Q1 (右上) X+ Y-</div>
                        <select id="q1_pattern" class="quad-select" onchange="render()"><option value="none">None</option><option value="line">Line</option><option value="zigzag" selected>Zig</option></select>
                        <select id="q1_travel" class="quad-select" onchange="render()">
                            <option value="snake" selected>Snake</option><option value="jump">Jump</option><option value="jumpsnake">J-Snake</option>
                        </select>
                        <select id="q1_corner" class="quad-select" onchange="render()"><option value="tr" selected>起:右上</option><option value="tl">起:左上</option><option value="br">起:右下</option><option value="bl">起:左下</option></select>
                    </div>
                    <div class="quad-box" style="border-color:#ff9800;">
                        <div class="quad-title" style="color:#ef6c00;">Q3 (左下) X- Y+</div>
                        <select id="q3_pattern" class="quad-select" onchange="render()"><option value="none" selected>None</option><option value="line">Line</option><option value="zigzag">Zig</option></select>
                        <select id="q3_travel" class="quad-select" onchange="render()">
                            <option value="snake" selected>Snake</option><option value="jump">Jump</option><option value="jumpsnake">J-Snake</option>
                        </select>
                        <select id="q3_corner" class="quad-select" onchange="render()"><option value="bl" selected>起:左下</option><option value="br">起:右下</option><option value="tl">起:左上</option><option value="tr">起:右上</option></select>
                    </div>
                    <div class="quad-box" style="border-color:#9c27b0;">
                        <div class="quad-title" style="color:#6a1b9a;">Q4 (右下) X+ Y+</div>
                        <select id="q4_pattern" class="quad-select" onchange="render()"><option value="none" selected>None</option><option value="line">Line</option><option value="zigzag">Zig</option></select>
                        <select id="q4_travel" class="quad-select" onchange="render()">
                            <option value="snake" selected>Snake</option><option value="jump">Jump</option><option value="jumpsnake">J-Snake</option>
                        </select>
                        <select id="q4_corner" class="quad-select" onchange="render()"><option value="br" selected>起:右下</option><option value="bl">起:左下</option><option value="tr">起:右上</option><option value="tl">起:左上</option></select>
                    </div>
                </div>
                <div class="input-row start-flag-row"><label>第一點 Flag:</label><input type="number" id="q_start_f" value="2"></div>
            </div>

            <div class="group-params group-rect">
                <div class="section-title">2. 矩形設定</div>
                <div class="input-row"><label>寬 W (mm):</label><input type="number" id="r_w" value="50.0"></div>
                <div class="input-row"><label>高 H (mm):</label><input type="number" id="r_h" value="50.0"></div>
                <div class="input-row"><label>線段 Len:</label><input type="number" id="r_seg_len" value="0.4"></div>
                <div class="input-row"><label>X 間距:</label><input type="number" id="r_pitch_x" value="1.7"></div>
                <div class="input-row"><label>Y 間距:</label><input type="number" id="r_pitch_y" value="1.7"></div>
                <div class="radio-group" style="margin-bottom:10px;">
                    <label><input type="radio" name="r_travel" value="jump" onchange="render()"> Jump</label>
                    <label><input type="radio" name="r_travel" value="snake" checked onchange="render()"> Snake</label>
                    <label><input type="radio" name="r_travel" value="jumpsnake" onchange="render()"> J-Snake</label>
                </div>
                <div class="input-row"><label>起點:</label><div class="corner-grid"><div class="corner-btn active" id="btn-r-tl" onclick="setCorner('r','tl')">左上</div><div class="corner-btn" id="btn-r-tr" onclick="setCorner('r','tr')">右上</div><div class="corner-btn" id="btn-r-bl" onclick="setCorner('r','bl')">左下</div><div class="corner-btn" id="btn-r-br" onclick="setCorner('r','br')">右下</div></div><input type="hidden" id="r_corner" value="tl"></div>
                <div class="input-row start-flag-row"><label>第一點 Flag:</label><input type="number" id="r_start_f" value="2"></div>
            </div>

            <div class="group-params group-zigzag">
                <div class="section-title">3. Z字形設定</div>
                <div class="input-row"><label>X 總長:</label><input type="number" id="z_maxx" value="100.0"></div>
                <div class="input-row"><label>Y 總長:</label><input type="number" id="z_maxy" value="100.0"></div>
                <div class="input-row"><label>Drop:</label><input type="number" id="z_drop" value="0.4"></div>
                <div class="input-row"><label>Step:</label><input type="number" id="z_step" value="1.0"></div>
                <div class="input-row"><label>Row Pitch:</label><input type="number" id="z_row" value="1.7"></div>
                <div class="radio-group" style="margin-bottom:10px;">
                    <label><input type="radio" name="z_travel" value="jump" onchange="render()"> Jump</label>
                    <label><input type="radio" name="z_travel" value="snake" checked onchange="render()"> Snake</label>
                    <label><input type="radio" name="z_travel" value="jumpsnake" onchange="render()"> J-Snake</label>
                </div>
                <div class="input-row"><label>起點:</label><div class="corner-grid"><div class="corner-btn active" id="btn-z-tl" onclick="setCorner('z','tl')">左上</div><div class="corner-btn" id="btn-z-tr" onclick="setCorner('z','tr')">右上</div><div class="corner-btn" id="btn-z-bl" onclick="setCorner('z','bl')">左下</div><div class="corner-btn" id="btn-z-br" onclick="setCorner('z','br')">右下</div></div><input type="hidden" id="z_corner" value="tl"></div>
                <div class="input-row start-flag-row"><label>第一點 Flag:</label><input type="number" id="z_start_f" value="2"></div>
            </div>

            <div class="btn-group">
                <button class="btn-refresh" onclick="render()">更新預覽</button>
            </div>
            <div class="btn-group">
                <button class="btn-blue" onclick="downloadSVG()">下載 SVG</button>
                <button class="btn-green" onclick="downloadCSV('all')">下載 CSV (全)</button>
            </div>
            <div class="btn-group group-params group-quadrant" style="margin-top:5px; flex-wrap:wrap; gap:5px;">
                <button class="btn-dl-sub" onclick="downloadCSV('Q1')">下載 Q1</button>
                <button class="btn-dl-sub" onclick="downloadCSV('Q2')">下載 Q2</button>
                <button class="btn-dl-sub" onclick="downloadCSV('Q3')">下載 Q3</button>
                <button class="btn-dl-sub" onclick="downloadCSV('Q4')">下載 Q4</button>
            </div>
        </div>

        <div class="canvas-container">
            <svg id="svgCanvas" width="650" height="650" viewBox="-110 -110 220 220"></svg>
            <div class="legend" id="legend-area"></div>
            <div class="status-box" id="status-text">準備就緒</div>
        </div>
    </div>

    <script>
        let currentMode = 'wafer';
        let csvData = []; 

        function setMode(mode) {
            currentMode = mode;
            document.body.className = `mode-${mode}-active`;
            const wDims = document.getElementById('wafer-dims');
            if(mode === 'wafer' || mode === 'quadrant') wDims.style.display = 'block';
            else wDims.style.display = 'none';
            render();
        }

        function setCorner(prefix, corner) {
            document.getElementById(`${prefix}_corner`).value = corner;
            ['tl','tr','bl','br'].forEach(c => {
                const btn = document.getElementById(`btn-${prefix}-${c}`);
                if(btn) {
                    if(c === corner) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });
            render();
        }

        function getVal(id) { const el = document.getElementById(id); return el ? (parseFloat(el.value) || 0) : 0; }
        function getRadioVal(name) { const els = document.getElementsByName(name); for (let i = 0; i < els.length; i++) if (els[i].checked) return els[i].value; return ""; }

        function render() {
            try {
                const svg = document.getElementById('svgCanvas');
                svg.innerHTML = ''; 
                const stroke = getVal('v_stroke') || 0.1;

                if (currentMode === 'wafer') {
                    drawWaferBasedMode(svg, stroke, 'wafer');
                    updateLegend('wafer');
                } else if (currentMode === 'rect') {
                    drawRectMode(svg, stroke);
                    updateLegend('rect');
                } else if (currentMode === 'zigzag') {
                    drawZigzagMode(svg, stroke);
                    updateLegend('zigzag');
                } else if (currentMode === 'quadrant') {
                    drawWaferBasedMode(svg, stroke, 'quadrant');
                    updateLegend('wafer');
                }
                document.getElementById('status-text').innerText = `路徑生成完畢 (${csvData.length} 點)`;
                calculateTime();
            } catch (err) {
                console.error(err);
                document.getElementById('status-text').innerText = "錯誤: " + err.message;
            }
        }

        function calculateTime() {
            const vWork = getVal('speed_work'), vJump = getVal('speed_jump');
            const tAcc = getVal('time_acc'); // 加減速時間
            
            let distWork = 0, distJump = 0, segCount = 0;
            
            if (csvData.length > 1) {
                let lastX = 0, lastY = 0;
                let p0 = csvData[0];
                distJump += Math.sqrt(p0.x*p0.x + p0.y*p0.y); 
                segCount++; // 初始移動算一段
                lastX = p0.x; lastY = p0.y;
                
                for (let i = 1; i < csvData.length; i++) {
                    let p = csvData[i];
                    let d = Math.sqrt(Math.pow(p.x - lastX, 2) + Math.pow(p.y - lastY, 2));
                    if (p.f === 2) distJump += d; else distWork += d;
                    segCount++; // 每一個點的移動都算一段(需要加減速)
                    lastX = p.x; lastY = p.y;
                }
            }
            const totalTimeSec = (vWork > 0 ? distWork/vWork : 0) + (vJump > 0 ? distJump/vJump : 0) + (segCount * tAcc);
            const totalDistM = (distWork + distJump) / 1000.0;
            const mm = Math.floor(totalTimeSec / 60); const ss = Math.floor(totalTimeSec % 60);
            document.getElementById('res_dist').innerText = totalDistM.toFixed(2) + " m";
            document.getElementById('res_segs').innerText = segCount;
            document.getElementById('res_time').innerText = `${mm}分 ${ss}秒`;
        }

        function updateLegend(mode) {
            const el = document.getElementById('legend-area');
            let html = `<div class="leg-item"><div class="line-demo" style="background:#aaa; height:1px;"></div> 軸</div>`;
            html += `<div class="leg-item"><div class="line-demo" style="border-top:2px dotted red;"></div> F2 (Jump)</div>`;
            html += `<div class="leg-item"><div class="line-demo" style="background:#00c853;"></div> F1 (Disp)</div>`;
            html += `<div class="leg-item"><div class="line-demo" style="border-top:2px dashed #999;"></div> F0 (Move)</div>`;
            if (mode === 'wafer') html += `<div class="leg-item"><div class="color-box" style="background:#e3f2fd; border:1px solid #2196f3;"></div> 晶片</div>`;
            el.innerHTML = html;
        }

        // ================== LOGIC ==================

        function drawWaferBasedMode(svg, baseStroke, modeType) {
            const dia = getVal('w_dia'); const margin = getVal('w_margin');
            const dieW = getVal('w_die_w'); const dieH = getVal('w_die_h'); const scribe = getVal('w_scribe');
            const gridPitchX = dieW + scribe; const gridPitchY = dieH + scribe;
            const radius = (dia * 25.4 - margin) / 2.0; const rSq = radius * radius;

            const limit = Math.max(radius * 1.1, 10);
            svg.setAttribute('viewBox', `-${limit} -${limit} ${limit*2} ${limit*2}`);
            drawAxes(svg, limit, baseStroke);
            addCircle(svg, 0, 0, dia * 25.4 / 2, "#ccc", null, baseStroke);
            addCircle(svg, 0, 0, radius, "#ff5252", "5,2", baseStroke);

            let validDies = []; let gridPath = "";
            const rangeX = Math.ceil(radius / gridPitchX); const rangeY = Math.ceil(radius / gridPitchY);
            if (rangeX * rangeY < 50000) {
                for(let j = -rangeY; j <= rangeY; j++) {
                    for(let i = -rangeX; i <= rangeX; i++) {
                        let cx = i * gridPitchX, cy = j * gridPitchY;
                        let l=cx-dieW/2, r=cx+dieW/2, t=cy-dieH/2, b=cy+dieH/2;
                        if(l*l+t*t<=rSq && r*r+t*t<=rSq && l*l+b*b<=rSq && r*r+b*b<=rSq) {
                            if (document.getElementById('v_show_grid').checked) gridPath += `M${l.toFixed(3)},${t.toFixed(3)}h${dieW}v${dieH}h-${dieW}z `;
                            let quad = "Q1";
                            if (cx > 0 && cy < 0) quad = "Q1";
                            else if (cx <= 0 && cy < 0) quad = "Q2";
                            else if (cx <= 0 && cy >= 0) quad = "Q3";
                            else quad = "Q4";
                            validDies.push({i, j, cx, cy, quad});
                        }
                    }
                }
            }
            if (gridPath) {
                let p = document.createElementNS("http://www.w3.org/2000/svg","path");
                p.setAttribute("d", gridPath); p.setAttribute("fill", "#e3f2fd"); p.setAttribute("stroke", "#2196f3"); p.setAttribute("stroke-width", baseStroke);
                svg.appendChild(p);
            }

            csvData = [];
            const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            let processOrder = [];
            if (modeType === 'wafer') processOrder = [{id:'all', dies: validDies}];
            else processOrder = ['Q1','Q2','Q3','Q4'].map(q => ({id:q, dies:validDies.filter(d=>d.quad===q)}));

            let isGlobalFirst = true;

            processOrder.forEach(batch => {
                if (batch.dies.length === 0) return;
                let pattern, travel, corner, startF, len;
                if (modeType === 'wafer') {
                    pattern = getRadioVal('w_pattern'); travel = getRadioVal('w_travel');
                    corner = document.getElementById('w_corner').value; startF = getVal('w_start_f'); len = getVal('w_seg_len');
                } else {
                    let id = batch.id.toLowerCase();
                    pattern = document.getElementById(`${id}_pattern`).value; if (pattern === 'none') return;
                    travel = document.getElementById(`${id}_travel`).value;
                    corner = document.getElementById(`${id}_corner`).value; startF = getVal('q_start_f'); len = getVal('w_seg_len');
                }

                batch.dies.sort((a, b) => {
                    let dy = 0;
                    if (corner === 'tl' || corner === 'tr') dy = a.j - b.j;
                    else dy = b.j - a.j;
                    if (dy !== 0) return dy;
                    if (corner === 'tl' || corner === 'bl') return a.i - b.i;
                    else return b.i - a.i;
                });

                let rows=[], curR=[], curJ=batch.dies[0].j;
                batch.dies.forEach(d => { if(d.j!==curJ){ rows.push(curR); curR=[]; curJ=d.j; } curR.push(d); });
                if(curR.length) rows.push(curR);

                let isFirstInBatch = true; 

                rows.forEach((row, rIdx) => {
                    let needReverse = false;
                    if (travel === 'snake' && rIdx % 2 !== 0) needReverse = true;
                    if (needReverse) row.reverse();

                    let isFirstInRow = true;

                    // == JUMPSNAKE LOGIC START (Between Rows) ==
                    if (travel === 'jumpsnake' && !isGlobalFirst && !isFirstInBatch && csvData.length > 0) {
                        let lastPt = csvData[csvData.length - 1];
                        let nextRowStartPt = (pattern==='line') ? {x: row[0].cx - len/2, y: row[0].cy} : {x: row[0].cx, y: row[0].cy + len/2};
                        
                        let scribeY = (lastPt.y + nextRowStartPt.y) / 2.0;
                        
                        addLine(group, lastPt.x, lastPt.y, lastPt.x, scribeY, "red", baseStroke, "4,2");
                        csvData.push({x: lastPt.x, y: scribeY, f: 2, q: batch.id});
                        
                        addLine(group, lastPt.x, scribeY, nextRowStartPt.x, scribeY, "red", baseStroke, "4,2");
                        csvData.push({x: nextRowStartPt.x, y: scribeY, f: 2, q: batch.id});
                    }
                    // == JUMPSNAKE LOGIC END ==

                    row.forEach(die => {
                        let segStart, segEnd;
                        if (pattern === 'line') { segStart={x:die.cx-len/2,y:die.cy}; segEnd={x:die.cx+len/2,y:die.cy}; } 
                        else { segStart={x:die.cx,y:die.cy+len/2}; segEnd={x:die.cx,y:die.cy-len/2}; }

                        let f = 0; if (isFirstInRow) f = 2;
                        if (isGlobalFirst) { f = startF; isGlobalFirst = false; }

                        if (csvData.length > 0) {
                            let last = csvData[csvData.length-1];
                            let c = f===2 ? "red" : "#999"; let d = f===2 ? "4,2" : "2,1";
                            addLine(group, last.x, last.y, segStart.x, segStart.y, c, baseStroke, d);
                        }
                        
                        csvData.push({x: segStart.x, y: segStart.y, f: f, q: batch.id});
                        addLine(group, segStart.x, segStart.y, segEnd.x, segEnd.y, "#00c853", baseStroke*3);
                        csvData.push({x: segEnd.x, y: segEnd.y, f: 1, q: batch.id});
                        isFirstInRow = false;
                        isFirstInBatch = false;
                    });
                });
            });
            svg.appendChild(group);
        }

        // --- Rect Mode ---
        function drawRectMode(svg, baseStroke) {
            const w=getVal('r_w'), h=getVal('r_h'), len=getVal('r_seg_len');
            const px=getVal('r_pitch_x'), py=getVal('r_pitch_y'), startF=getVal('r_start_f');
            const travel=getRadioVal('r_travel'), corner=document.getElementById('r_corner').value;

            const limit=Math.max(w,h)*0.6; svg.setAttribute('viewBox',`-${limit} -${limit} ${limit*2} ${limit*2}`);
            drawAxes(svg,limit,baseStroke);
            let r=document.createElementNS("http://www.w3.org/2000/svg","rect");
            r.setAttribute("x",-w/2); r.setAttribute("y",-h/2); r.setAttribute("width",w); r.setAttribute("height",h);
            r.setAttribute("fill","none"); r.setAttribute("stroke","#ff5252"); r.setAttribute("stroke-dasharray","5,2"); r.setAttribute("stroke-width",baseStroke);
            svg.appendChild(r);

            csvData=[]; const group=document.createElementNS("http://www.w3.org/2000/svg","g");
            const cX=Math.floor(w/2/px), cY=Math.floor(h/2/py);
            
            let gridPts = [];
            for(let j=-cY; j<=cY; j++) {
                for(let i=-cX; i<=cX; i++) {
                    let cx=i*px, cy=j*py, x1=cx-len/2, x2=cx+len/2;
                    if(x1>=-w/2 && x2<=w/2) gridPts.push({cx,cy});
                }
            }
            gridPts.sort((a,b) => {
                let dy = 0;
                if (corner === 'tl' || corner === 'tr') dy = a.cy - b.cy;
                else dy = b.cy - a.cy;
                if(dy!==0) return dy;
                if (corner === 'tl' || corner === 'bl') return a.cx - b.cx;
                else return b.cx - a.cx;
            });

            let rows=[], curR=[], curJ=gridPts[0]?.cy;
            gridPts.forEach(p => { if(Math.abs(p.cy-curJ)>0.001){ rows.push(curR); curR=[]; curJ=p.cy; } curR.push(p); });
            if(curR.length) rows.push(curR);

            let isFF=true;
            rows.forEach((row, rIdx) => {
                if(travel==='snake' && rIdx%2!==0) row.reverse();
                
                // JUMPSNAKE Logic
                if (travel === 'jumpsnake' && rIdx > 0 && csvData.length > 0) {
                    let lastPt = csvData[csvData.length - 1];
                    let nextStart = {x: row[0].cx - len/2, y: row[0].cy};
                    let scribeY = (lastPt.y + nextStart.y) / 2.0;
                    
                    addLine(group, lastPt.x, lastPt.y, lastPt.x, scribeY, "red", baseStroke, "4,2");
                    csvData.push({x: lastPt.x, y: scribeY, f: 2, q: 'R'});
                    
                    addLine(group, lastPt.x, scribeY, nextStart.x, scribeY, "red", baseStroke, "4,2");
                    csvData.push({x: nextStart.x, y: scribeY, f: 2, q: 'R'});
                }

                let isFR=true;
                row.forEach(pt => {
                    let p1={x:pt.cx-len/2,y:pt.cy}, p2={x:pt.cx+len/2,y:pt.cy};
                    if(travel==='snake' && rIdx%2!==0) { let t=p1; p1=p2; p2=t; }

                    let f=0; if(isFR) f=2; if(isFF){ f=startF; isFF=false; }
                    
                    if(csvData.length>0){
                        let last=csvData[csvData.length-1];
                        let c=f===2?"red":"#999", d=f===2?"4,2":"2,1";
                        addLine(group,last.x,last.y,p1.x,p1.y,c,baseStroke,d);
                    }
                    csvData.push({x:p1.x,y:p1.y,f:f,q:'R'});
                    addLine(group,p1.x,p1.y,p2.x,p2.y,"#00c853",baseStroke*3);
                    csvData.push({x:p2.x,y:p2.y,f:1,q:'R'});
                    isFR=false;
                });
            });
            svg.appendChild(group);
        }

        function drawZigzagMode(svg, baseStroke) {
            const mx=getVal('z_maxx'), my=getVal('z_maxy'), drop=getVal('z_drop');
            const step=getVal('z_step'), row=getVal('z_row'), startF=getVal('z_start_f');
            const travel=getRadioVal('z_travel'), corner=document.getElementById('z_corner').value;

            const limit=10; svg.setAttribute('viewBox',`-${limit} -${my+limit} ${mx+limit*2} ${my+limit*2}`);
            drawAxes(svg, limit, baseStroke); 
            csvData=[]; const group=document.createElementNS("http://www.w3.org/2000/svg","g");

            let rowsY = []; let currY = 0;
            while(currY >= -my) { rowsY.push(currY); currY -= row; }
            if(corner==='bl' || corner==='br') rowsY.reverse();

            let isFF=true;
            rowsY.forEach((y, rIdx) => {
                let isRev = (corner==='tr' || corner==='br');
                if(travel==='snake' && rIdx%2!==0) isRev = !isRev;

                // JUMPSNAKE Logic
                if (travel === 'jumpsnake' && rIdx > 0 && csvData.length > 0) {
                    let lastPt = csvData[csvData.length - 1];
                    let nextStartX = isRev ? (Math.floor(mx/step)*step) : 0; 
                    let scribeY = (lastPt.y + y) / 2.0;
                    
                    addLine(group, lastPt.x, lastPt.y, lastPt.x, scribeY, "red", baseStroke, "4,2");
                    csvData.push({x: lastPt.x, y: scribeY, f: 2, q: 'Z'});
                    
                    addLine(group, lastPt.x, scribeY, nextStartX, scribeY, "red", baseStroke, "4,2");
                    csvData.push({x: nextStartX, y: scribeY, f: 2, q: 'Z'});
                }

                let pts = [];
                if(!isRev) { 
                    let cx=0; while(cx < mx) { pts.push({x:cx, y:y-drop, f:1}); let nx=cx+step; pts.push({x:nx, y:y, f:0}); cx=nx; }
                } else { 
                    let cx=Math.floor(mx/step)*step; while(cx >= 0) { pts.push({x:cx, y:y-drop, f:1}); let nx=cx-step; if(nx>=0) pts.push({x:nx, y:y, f:0}); cx=nx; }
                }

                if(pts.length>0) {
                    let startX = pts[0].x; 
                    let f=2; if(isFF) { f=startF; isFF=false; }
                    let jumpPt = {x:startX, y:y, f:f, q:'Z'};
                    
                    if(csvData.length>0) { 
                        let lp=csvData[csvData.length-1]; 
                        addLine(group,lp.x,lp.y,jumpPt.x,jumpPt.y,"red",baseStroke,"4,2"); 
                    }
                    csvData.push(jumpPt);
                    let lp=jumpPt;
                    pts.forEach(p=>{
                        let col=p.f===1?"#007ACC":"#999", w=p.f===1?baseStroke*1.5:baseStroke, d=p.f===0?"2,1":null;
                        addLine(group,lp.x,lp.y,p.x,p.y,col,w,d);
                        csvData.push({x:p.x, y:p.y, f:p.f, q:'Z'}); lp=p;
                    });
                }
            });
            svg.appendChild(group);
        }

        // --- Utils ---
        function downloadCSV(filter) {
            if (!csvData.length) { alert("無數據"); return; }
            let content = ""; let subset = csvData;
            if (filter && filter !== 'all') { subset = csvData.filter(d => d.q === filter); if (!subset.length) { alert("該象限無數據"); return; } }
            subset.forEach(d => { content += `${d.x.toFixed(3)},${d.y.toFixed(3)},${d.f}\n`; });
            const blob = new Blob([content], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filter ? `${currentMode}_${filter}.csv` : `${currentMode}_data.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function downloadSVG() {
            const s=document.getElementById('svgCanvas'); const x=new XMLSerializer(); let d=x.serializeToString(s);
            if(!d.match(/^<svg[^>]+xmlns/)) d=d.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"');
            const b=new Blob([d],{type:"image/svg+xml"}); const a=document.createElement("a");
            a.href=URL.createObjectURL(b); a.download=`${currentMode}_preview.svg`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function drawAxes(p,l,s){ addLine(p,-l,0,l,0,"#aaa",s); addLine(p,0,-l,0,l,"#aaa",s); }
        function addCircle(p,x,y,r,s,d,w){ const c=document.createElementNS("http://www.w3.org/2000/svg","circle"); c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",r); c.setAttribute("fill","none"); c.setAttribute("stroke",s); if(d) c.setAttribute("stroke-dasharray",d); if(w!==null) c.setAttribute("stroke-width",w); p.appendChild(c); }
        function addLine(p,x1,y1,x2,y2,c,w,d){ const l=document.createElementNS("http://www.w3.org/2000/svg","line"); l.setAttribute("x1",x1); l.setAttribute("y1",y1); l.setAttribute("x2",x2); l.setAttribute("y2",y2); l.setAttribute("stroke",c); l.setAttribute("stroke-width",w); if(d) l.setAttribute("stroke-dasharray",d); p.appendChild(l); }

        window.onload = function() { setMode('wafer'); };
    </script>
</body>
</html>